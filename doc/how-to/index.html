<!doctype html>
<html>

<head>
    <meta charset="utf-8">

    <title>Plane</title>

    <style>
        /* html structure */
        html,
        body {
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
        /* html structure */
        /* application structure */
        header {
            top: 0px;
            height: 40px;
            background-color: rgb(211, 222, 232);
        }
        aside {
            background-color: rgb(166, 217, 166);
        }
        aside[id=left] {
            position: absolute;
            left: 0px;
            top: 40px;
            bottom: 0px;
            width: 75px;
        }
        aside[id=right] {
            position: absolute;
            right: 0px;
            top: 40px;
            bottom: 0px;
            width: 200px;
        }
        section {
            position: absolute;
            top: 40px;
            left: 75px;
            right: 200px;
            bottom: 40px;
            background-color: rgb(234, 231, 231);
        }
        footer {
            position: absolute;
            left: 75px;
            right: 200px;
            bottom: 0px;
            height: 40px;
            background-color: rgb(239, 239, 212);
        }
        /* application structure */
        /* application components */
        canvas[id="rullery"] {
            position: absolute;
            height: 100%;
            width: 15px;
            background-color: rgb(204, 139, 139);
        }
        canvas[id="rullerx"] {
            position: absolute;
            bottom: 0px;
            height: 15px;
            width: 100%;
            background-color: rgb(204, 139, 139);
        }
        div[id="viewPort"] {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            background-color: rgb(255, 255, 255);
        }
        #ui-mouse-cursor {
            position: absolute;
            top: 0px;
            left: 300px;
            width: 20px;
            height: 20px;
            z-index: 0;
        }
        .ui-tool-make-mark {
            position: absolute;
            left: 350px;
            top: 50px;
            z-index: 1;
        }
        .ui-tool-make-intersection {
            position: absolute;
            left: 370px;
            top: 50px;
            z-index: 1;
        }
        /* application components */
    </style>

    <script src="../../dist/plane-3.0.0.js"></script>

    <script>
        window.onload = function () {
            var viewPort = document.getElementById("viewPort");

            // plane - initialize
            plane.initialize({
                viewPort: viewPort
            });
            // plane - initialize

            plane.shape.create({
                type: 'arc',
                center: [700, 250],
                radius: 50,
                startAngle: 90,
                endAngle: 270
            });
            plane.shape.create({
                type: 'arc',
                center: [1200, 300],
                radius: 30,
                startAngle: 360,
                endAngle: 90
            });

            plane.shape.create({
                type: 'bezier-cubic',
                points: [[60, 190], [80, 10], [500, 10], [520, 190]]
            });

            plane.shape.create({
                type: 'bezier-quadratic',
                points: [[700, 100], [860, 0], [1000, 100]]
            });

            plane.shape.create({
                type: 'circle',
                center: [1200, 100],
                radius: 50
            });

            plane.shape.create({
                type: 'ellipse',
                center: [400, 300],
                radiusY: 50,
                radiusX: 100
            });

            plane.shape.create({
                type: 'line',
                from: [150, 450],
                to: [600, 450]
            });
            plane.shape.create({
                type: 'line',
                from: [50, 50],
                to: [50, 320],
            });
            //            plane.shape.create({
            //                type: 'line',
            //                from: [50, 50],
            //                to: [50, 320],
            //                style: {
            //                    lineColor: 'rgb(32, 184, 96)',
            //                    lineDash: true
            //                }
            //            });

            plane.shape.create({
                type: 'polygon',
                center: [900, 400],
                radius: 70,
                sides: 5
            });

            plane.shape.create({
                type: 'polyline',
                points: [[700, 100], [860, 0], [1000, 100]]
            });
            plane.shape.create({
                type: 'polyline',
                points: [[60, 190], [80, 10], [500, 10], [520, 190]]
            });

            plane.shape.create({
                type: 'rectangle',
                from: [0, 0],
                to: [viewPort.clientWidth, viewPort.clientHeight]
            });
            plane.shape.create({
                type: 'rectangle',
                from: [1350, 100],
                to: [1550, 300]
            });

            plane.shape.create({
                type: 'spline',
                degree: 3,
                knots: [0, 0, 0, 0, 1, 2, 3, 4, 4, 4, 4],
                points: [
                    [1099.987144430972, 649.9876187248264],
                    [1110.097044818745, 670.0304621818222],
                    [1120.20695803644, 649.9876187248264],
                    [1129.990734674595, 692.028699594638],
                    [1140.426771641907, 650.1505693076124],
                    [1149.884424530442, 669.7045610162513],
                    [1159.668201168597, 650.3135198903983]
                ]
            });
            plane.shape.create({
                type: 'polyline',
                points: [
                    [1099.987144430972, 649.9876187248264],
                    [1110.097044818745, 670.0304621818222],
                    [1120.20695803644, 649.9876187248264],
                    [1129.990734674595, 692.028699594638],
                    [1140.426771641907, 650.1505693076124],
                    [1149.884424530442, 669.7045610162513],
                    [1159.668201168597, 650.3135198903983]
                ]
            });



            plane.view.update();



            console.log('nº de shapes - ' + plane.shape.search({
                type: 'inView'
            }).length);



            var toolZoomWheel = plane.tool.create({
                active: true
            });
            toolZoomWheel.events.listen('onMouseWheel', function (event) {

                var position = event.point,
                    zoomNew = event.delta < 0 ? plane.view.zoom / .83 : plane.view.zoom * .83,
                    zoomFactor = plane.view.zoom / zoomNew;

                var centerFactor = position.subtract(plane.view.center);
                var centerSum = position.subtract(centerFactor.multiply(zoomFactor)).subtract(plane.view.center);
                var centerNew = plane.view.center.sum(centerSum);

                plane.view.zoomTo(zoomNew, centerNew);

                console.log('nº de shapes - ' + plane.shape.search({
                    type: 'inView'
                }).length);

            });



            var toolSelect = plane.tool.create({
                    active: true
                }),
                toolSelectShapesOver = [];
            toolSelect.events.listen('onMouseDown', function (event) {

                plane.layer.active.children.list().forEach(function (shape) {
                    if (shape.status == 'temporary') {
                        plane.layer.active.children.remove(shape.uuid);
                    }
                });

                plane.view.update();

            });
            toolSelect.events.listen('onMouseMove', function (event) {

                // para o movimento do cursor
                var x = event.point.inView.x,
                    y = event.point.inView.y;

                var xxx = plane.point.create(x * plane.view.transform.a + y * plane.view.transform.b + plane.view.transform.tx, x * plane.view.transform.c + y * plane.view.transform.d + plane.view.transform.ty);
                document.getElementById('ui-mouse-cursor').style.top = ((xxx.y - plane.view.size.height) * -1) - 10 + 'px';
                document.getElementById('ui-mouse-cursor').style.left = xxx.x - 10 + 'px';
                // para o movimento do cursor

                var shapesInView = plane.shape.search({
                    type: 'inView'
                });

                if (shapesInView.length > 0) {

                    // sempre limpo os shapes over
                    if (toolSelectShapesOver.length > 0) {
                        toolSelectShapesOver.forEach(function (shape) {
                            plane.shape.find(shape).style = null;
                        });
                        toolSelectShapesOver = [];
                    }

                    shapesInView.forEach(function (shape) {
                        if ((shape.status != 'line') && (shape.status != 'intersect') && shape.contains(event.point.inCanvas, plane.view.transform)) {
                            shape.style = {
                                lineColor: 'rgb(221, 106, 100)'
                            };
                            toolSelectShapesOver.push(shape);
                        }
                    });

                    plane.view.update();

                }

            });
            toolSelect.events.listen('onMouseDrag', function (event) {

                plane.shape.list().forEach(function (shape) {
                    if (shape.status == 'temporary') {
                        plane.layer.active.children.remove(shape.uuid);
                    }
                });

                var selectRectangle = plane.shape.create({
                    type: 'rectangle',
                    from: [event.point.first.x, event.point.first.y],
                    to: [event.point.last.x, event.point.last.y],
                    style: {
                        lineDash: true,
                        lineColor: 'rgb(221, 106, 100)'
                    },
                    status: 'temporary'
                });


                plane.layer.active.children.list().forEach(function (shape) {

                    var rectangle = {
                        to: event.point.first,
                        from: event.point.last
                    };

                    if ((selectRectangle.name != shape.name) && (shape.intersect(rectangle))) {
                        console.log(shape.name);
                    }
                });

                plane.view.update();

            });


            var toolLine = plane.tool.create({
                    active: true
                }),
                toolLineFirstPoint = null,
                toolLineIntersect = null;

            toolLine.events.listen('onMouseMove', function (event) {


                if ((toolSelectShapesOver.length > 0) && (toolSelectShapesOver[0].type == 'line')) {

                    var line = toolSelectShapesOver[0],
                        lineMiddle = line.from.midTo(line.to);

                    var markFrom = document.querySelector('.ui-tool-make-mark').cloneNode(true),
                        markMiddle = document.querySelector('.ui-tool-make-mark').cloneNode(true),
                        markTo = document.querySelector('.ui-tool-make-mark').cloneNode(true);

                    document.querySelector('#viewPort').appendChild(markFrom);
                    document.querySelector('#viewPort').appendChild(markMiddle);
                    document.querySelector('#viewPort').appendChild(markTo);

                    var pointFrom = plane.point.create(line.from.x * plane.view.transform.a + line.from.y * plane.view.transform.b + plane.view.transform.tx,
                        line.from.x * plane.view.transform.c + line.from.y * plane.view.transform.d + plane.view.transform.ty);

                    var pointMiddle = plane.point.create(lineMiddle.x * plane.view.transform.a + lineMiddle.y * plane.view.transform.b + plane.view.transform.tx,
                        lineMiddle.x * plane.view.transform.c + lineMiddle.y * plane.view.transform.d + plane.view.transform.ty);

                    var pointTo = plane.point.create(line.to.x * plane.view.transform.a + line.to.y * plane.view.transform.b + plane.view.transform.tx,
                        line.to.x * plane.view.transform.c + line.to.y * plane.view.transform.d + plane.view.transform.ty);


                    markFrom.style.top = ((pointFrom.y - plane.view.size.height) * -1) - 4 + 'px';
                    markFrom.style.left = pointFrom.x - 4 + 'px';

                    markMiddle.style.top = ((pointMiddle.y - plane.view.size.height) * -1) - 4 + 'px';
                    markMiddle.style.left = pointMiddle.x - 4 + 'px';

                    markTo.style.top = ((pointTo.y - plane.view.size.height) * -1) - 4 + 'px';
                    markTo.style.left = pointTo.x - 4 + 'px';
                    markTo.dataset.point = line.to.toJson();




                    var delay = function (elem, callback) {
                        var timeout = null;
                        elem.onmouseover = function () {
                            // Set timeout to be a timer which will invoke callback after 1s
                            timeout = setTimeout(callback, 300);
                        };

                        elem.onmouseout = function () {
                            // Clear any timers set to timeout
                            clearTimeout(timeout);
                        }
                    };

                    delay(markTo, function () {
                        toolLineIntersect = !toolLineIntersect ? JSON.parse(markTo.dataset.point) : null;
                        //                        console.log(toolLineIntersect);
                    });

                }

                // para o movimento do cursor
                var x = event.point.inView.x,
                    y = event.point.inView.y;

                var xxx = plane.point.create(x * plane.view.transform.a + y * plane.view.transform.b + plane.view.transform.tx, x * plane.view.transform.c + y * plane.view.transform.d + plane.view.transform.ty);
                document.getElementById('ui-mouse-cursor').style.top = ((xxx.y - plane.view.size.height) * -1) - 10 + 'px';
                document.getElementById('ui-mouse-cursor').style.left = xxx.x - 10 + 'px';
                // para o movimento do cursor
                

                plane.shape.list().forEach(function (shape) {
                    if (shape.status == 'intersect') {
                        plane.shape.remove(shape);
                    }
                });

                if (toolLineIntersect) {

                    if (Math.abs(event.point.inView.x - toolLineIntersect.x) <= 10) {

                        var rectangle = {
                            from: plane.point.create(plane.view.transform.inverseTransform(plane.point.create(0, 0))),
                            to: plane.point.create(plane.view.transform.inverseTransform(plane.point.create(plane.view.size.width, plane.view.size.height)))
                        }

                        plane.shape.create({
                            type: 'line',
                            from: [toolLineIntersect.x, rectangle.from.y],
                            to: [toolLineIntersect.x, rectangle.to.y],
                            status: 'intersect',
                            style: {
                                lineColor: 'rgb(32, 184, 96)',
                                lineDash: true
                            }
                        });
                        
                        toolSelect.active = false;
                        
                        
                        // para o movimento do cursor
                        var x = toolLineIntersect.x,
                            y = event.point.inView.y;

                        var xxx = plane.point.create(x * plane.view.transform.a + y * plane.view.transform.b + plane.view.transform.tx, x * plane.view.transform.c + y * plane.view.transform.d + plane.view.transform.ty);
                        document.getElementById('ui-mouse-cursor').style.top = ((xxx.y - plane.view.size.height) * -1) - 10 + 'px';
                        document.getElementById('ui-mouse-cursor').style.left = xxx.x - 10 + 'px';
                        // para o movimento do cursor
                        
                    }





                    //                    var pointOrtho = null;
                    //
                    //                    var dx = event.point.inView.x - toolLineIntersect.x,
                    //                        dy = event.point.inView.y - toolLineIntersect.y;
                    //
                    //                    if (Math.abs(dx) > Math.abs(dy)) {
                    //                        pointOrtho = plane.point.create(event.point.inView.x, toolLineIntersect.y);
                    //                    } else {
                    //                        pointOrtho = plane.point.create(toolLineIntersect.x, event.point.inView.y);
                    //                    }
                    //
                    //                    plane.shape.create({
                    //                        type: 'line',
                    //                        from: toolLineIntersect,
                    //                        to: pointOrtho,
                    //                        status: 'intersect',
                    //                        style: {
                    //                            lineColor: 'rgb(32, 184, 96)',
                    //                            lineDash: true
                    //                        }
                    //                    });
                }



                if (toolLineFirstPoint) {

                    plane.shape.list().forEach(function (shape) {
                        if (shape.status == 'line') {
                            plane.shape.remove(shape);
                        }
                    });

                    var pointOrtho = null;

                    var dx = event.point.inView.x - toolLineFirstPoint.x,
                        dy = event.point.inView.y - toolLineFirstPoint.y;

                    if (Math.abs(dx) > Math.abs(dy)) {
                        pointOrtho = plane.point.create(event.point.inView.x, toolLineFirstPoint.y);
                    } else {
                        pointOrtho = plane.point.create(toolLineFirstPoint.x, event.point.inView.y);
                    }

                    plane.shape.create({
                        type: 'line',
                        from: toolLineFirstPoint,
                        to: pointOrtho,
                        status: 'line'
                    });


                }

                plane.view.update();

            });

            toolLine.events.listen('onMouseUp', function (event) {

                if (toolLineFirstPoint) {
                    plane.shape.list().forEach(function (shape) {
                        if (shape.status == 'line') {
                            // removo o status de temporário
                            plane.shape.find(shape).status = '';
                        }
                    });

                    plane.view.update();

                    toolLineFirstPoint = null;
                } else {
                    toolLineFirstPoint = event.point.inView;
                }
            });








            document.getElementById('fileImport').addEventListener('change', function () {

                var file = this.files[0],
                    filename = file.name;

                var lastDotPosition = filename.lastIndexOf('.'),
                    bareFilename = filename.substr(0, lastDotPosition),
                    fileExtension = filename.substr(lastDotPosition + 1).toLowerCase();

                var reader = new FileReader();
                reader.onload = function (event) {

                    var fileData = event.target.result;

                    switch (fileExtension) {
                    case 'dxf':
                        plane.importer.fromDxf(fileData);
                        break;
                    case 'json':
                        plane.importer.fromJson(fileData);
                        break;
                    default:
                        return;
                    }
                    plane.view.update();
                };
                reader.readAsText(file);

            });

            document.getElementById('exportJsonButton').addEventListener('click', function (event) {
                console.log(plane.exporter.toJson());
            });

            document.getElementById('zoomMoreButton').addEventListener('click', function (event) {
                plane.view.zoom /= .93;
            });

            document.getElementById('zoomLessButton').addEventListener('click', function (event) {
                plane.view.zoom *= .93;
            });

            document.getElementById('zoomHomeButton').addEventListener('click', function (event) {
                plane.view.reset();
            });

        };
    </script>

</head>

<body>

    <header>
    </header>

    <aside id="left">
    </aside>

    <section>
        <div id="viewPort">


            <svg id="ui-mouse-cursor" width="20px" height="20px" class="hide">
                <line fill="none" stroke="#000000" stroke-width="0.75" x1="10" y1="1" x2="10" y2="19" />
                <line fill="none" stroke="#000000" stroke-width="0.75" x1="1" y1="10" x2="19" y2="10" />
                <line fill="none" stroke="#000000" stroke-width="0.75" x1="10" y1="1" x2="10" y2="19" />
                <line fill="none" stroke="#000000" stroke-width="0.75" x1="1" y1="10" x2="19" y2="10" />
                <line fill="none" stroke="#000000" stroke-width="0.75" x1="10" y1="1" x2="10" y2="19" />
                <line fill="none" stroke="#000000" stroke-width="0.75" x1="1" y1="10" x2="19" y2="10" />
            </svg>

            <svg width="8px" height="8px" class="ui-tool-make-mark">
                <rect x="0" y="0" fill="#2DB560" width="8" height="8" />
            </svg>


            <svg width="10px" height="10px" class="ui-tool-make-intersection">
                <line stroke="rgb(32, 184, 96)" stroke-width="0.5" x1="0" y1="5" x2="10" y2="5" />
                <line stroke="rgb(32, 184, 96)" stroke-width="0.5" x1="5" y1="10" x2="5" y2="0" />
                <line stroke="rgb(32, 184, 96)" stroke-width="0.5" x1="0" y1="5" x2="10" y2="5" />
                <line stroke="rgb(32, 184, 96)" stroke-width="0.5" x1="5" y1="10" x2="5" y2="0" />
                <line stroke="rgb(32, 184, 96)" stroke-width="0.5" x1="0" y1="5" x2="10" y2="5" />
                <line stroke="rgb(32, 184, 96)" stroke-width="0.5" x1="5" y1="10" x2="5" y2="0" />
            </svg>



        </div>
    </section>

    <aside id="right">
        <ul id="layersControl">
        </ul>
        <div id="toolsPanel">
            <input id="fileImport" type="file"></input>
            <br>
            <br>
            <button id="exportJsonButton">Export Json</button>
            <br>
            <br>
            <button id="zoomMoreButton">Zoom +++</button>
            <button id="zoomLessButton">Zoom ---</button>
            <br>
            <br>
            <button id="zoomHomeButton">Home</button>
        </div>
        <ul id="shapesList">
        </ul>
    </aside>

    <footer>
    </footer>
</body>

</html>