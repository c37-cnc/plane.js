<!doctype html>
<html>

<head>
    <meta charset="utf-8">

    <title>Plane</title>

    <style>
        /* html structure */
        html,
        body {
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
        /* html structure */
        /* application structure */
        header {
            top: 0px;
            height: 40px;
            background-color: rgb(211, 222, 232);
        }
        aside {
            background-color: rgb(166, 217, 166);
        }
        aside[id=left] {
            position: absolute;
            left: 0px;
            top: 40px;
            bottom: 0px;
            width: 75px;
        }
        aside[id=right] {
            position: absolute;
            right: 0px;
            top: 40px;
            bottom: 0px;
            width: 200px;
        }
        section {
            position: absolute;
            top: 40px;
            left: 75px;
            right: 200px;
            bottom: 40px;
            background-color: rgb(234, 231, 231);
        }
        footer {
            position: absolute;
            left: 75px;
            right: 200px;
            bottom: 0px;
            height: 40px;
            background-color: rgb(239, 239, 212);
        }
        /* application structure */
        /* application components */
        canvas[id="rullery"] {
            position: absolute;
            height: 100%;
            width: 15px;
            background-color: rgb(204, 139, 139);
        }
        canvas[id="rullerx"] {
            position: absolute;
            bottom: 0px;
            height: 15px;
            width: 100%;
            background-color: rgb(204, 139, 139);
        }
        div[id="viewPort"] {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            background-color: rgb(255, 255, 255);
        }
        /* application components */
    </style>

    <script src="../../dist/plane-3.0.0.js"></script>

    <script>
        window.onload = function () {
            var viewPort = document.getElementById("viewPort");

            // plane - initialize
            plane.initialize({
                viewPort: viewPort
            });
            // plane - initialize

            plane.layer.create();

            plane.shape.create({
                type: 'rectangle',
                x: 0,
                y: 0,
                width: viewPort.clientWidth,
                height: viewPort.clientHeight
            });

            plane.shape.create({
                type: 'line',
                a: [350, 350],
                b: [600, 50]
            });
            plane.shape.create({
                type: 'polygon',
                x: 300,
                y: 500,
                radius: 70,
                sides: 5
            });
            plane.shape.create({
                type: 'rectangle',
                x: 300,
                y: 10,
                width: 125,
                height: 100
            });
            plane.shape.create({
                type: 'arc',
                x: 800,
                y: 150,
                radius: 50,
                startAngle: 0,
                endAngle: 180,
                clockWise: true
            });
            plane.shape.create({
                type: 'arc',
                x: 500,
                y: 250,
                radius: 50,
                startAngle: 90,
                endAngle: 180,
                clockWise: false
            });
            plane.shape.create({
                type: 'arc',
                x: 700,
                y: 250,
                radius: 50,
                startAngle: 90,
                endAngle: 270,
                clockWise: false
            });
            plane.shape.create({
                type: 'arc',
                x: 1000,
                y: 250,
                radius: 50,
                startAngle: 90,
                endAngle: 270,
                clockWise: true
            });
            plane.shape.create({
                type: 'arc',
                x: 1500,
                y: 600,
                radius: 30,
                startAngle: 90,
                endAngle: 180,
                clockWise: true
            });
            plane.shape.create({
                type: 'circle',
                x: 1200,
                y: 100,
                radius: 50
            });
            plane.shape.create({
                type: 'ellipse',
                x: 1000,
                y: 100,
                radiusY: 25,
                radiusX: 45
            });

            plane.update();


//            plane.update();
//            
//            plane.select.layer
//            plane.select.shapes
//            plane.select.groups
            







            var tool001 = plane.tool.create();
            tool001.active = true;

            console.log(tool001);

            tool001.events.listen('onMouseWheel', function (event) {
                console.log(event);
            });

//            tool001.events.listen('onMouseMove', function (event) {
//                console.log(event);
//            });


            document.getElementById('fileImport').addEventListener('change', function () {
                var file = this.files[0],
                    filename = file.name;

                var lastDotPosition = filename.lastIndexOf('.'),
                    bareFilename = filename.substr(0, lastDotPosition),
                    fileExtension = filename.substr(lastDotPosition + 1).toLowerCase();

                var reader = new FileReader();
                reader.onload = function (event) {

                    var fileData = event.target.result;

                    switch (fileExtension) {
                    case 'dxf':
                        plane.importer.fromDxf(fileData);
                        break;
                    case 'json':
                        plane.importer.fromJson(fileData);
                        break;
                    default:
                        return;
                    }

                };
                reader.readAsText(file);
            });

            document.getElementById('exportJsonButton').addEventListener('click', function (event) {
                console.log(plane.exporter.toJson());
            });

            document.getElementById('zoomMoreButton').addEventListener('click', function (event) {
                plane.view.zoom /= .97;
                
                // plane.view.zoom(plane.view.zoom() / .97);
                
                // plane.view.zoomTo(plane.view.zoom / .97, plane.view.center.position);
                // plane.view.zoomTo(1, plane.view.center.position);
            });

            document.getElementById('zoomLessButton').addEventListener('click', function (event) {
                plane.view.zoom *= .97;
                // plane.view.zoomTo(plane.view.zoom * .97, plane.view.center.position);
                // plane.view.zoomTo(-1, plane.view.center.position);
            });

            document.getElementById('zoomCenterButton').addEventListener('click', function (event) {
                plane.view.center = {
                    x: plane.view.center.x + parseFloat(document.getElementById('zoomCenterInputX').value),
                    y: plane.view.center.y + parseFloat(document.getElementById('zoomCenterInputY').value)
                }
                console.log(plane.view.bounds);
            });


            function mousePosition(element, x, y) {
                var bb = element.getBoundingClientRect();

                x = (x - bb.left) * (element.clientWidth / bb.width);
                y = (y - bb.top) * (element.clientHeight / bb.height);

                // tradução para o sistema de coordenadas cartesiano
                y = (y - element.clientHeight) * -1;

                return {
                    x: x,
                    y: y
                };
            };


            viewPort.addEventListener('msousewheel', function (event) {

  //              debugger;

//                                var viewPosition = mousePosition(viewPort, event.clientX, event.clientY),
//                                    zoomNew = event.wheelDelta > 1 ? 1 : -1,
//                                    zoomFactor = plane.view.zoom / event.wheelDelta < 1 ? 1.041666666666667 : .96;

                var viewPosition = mousePosition(viewPort, event.clientX, event.clientY),
                    zoomNew = event.wheelDelta > 1 ? plane.view.zoom / .97 : plane.view.zoom * .97,
                    zoomFactor = plane.view.zoom / zoomNew;

                var centerFactor = {
                    x: viewPosition.x - plane.view.center.position.x,
                    y: viewPosition.y - plane.view.center.position.y
                };

                var postionMultiply = {
                    x: centerFactor.x * zoomFactor,
                    y: centerFactor.y * zoomFactor
                };

                var moveFactor = {
                    x: (viewPosition.x - postionMultiply.x) - plane.view.center.position.x,
                    y: (viewPosition.y - postionMultiply.y) - plane.view.center.position.y
                };
                //                var moveFactor = {
                //                    x: postionMultiply.x - viewPosition.x,
                //                    y: postionMultiply.y - viewPosition.y
                //                };


                                plane.view.zoomTo(zoomNew, moveFactor);
//                plane.view.zoomTo(zoomNew, viewPosition);

            });


        };
    </script>

</head>

<body>

    <header>
    </header>

    <aside id="left">
    </aside>

    <section>
        <div id="viewPort">
        </div>
    </section>

    <aside id="right">
        <ul id="layersControl">
        </ul>
        <div id="toolsPanel">
            <input id="fileImport" type="file"></input>
            <button id="exportJsonButton">Export Json</button>
            <br>
            <br>
            <label>x</label>
            <input id="zoomCenterInputX" type="text" style="width:60px" value="0">
            <label>y</label>
            <input id="zoomCenterInputY" type="text" style="width:60px" value="0">
            <button id="zoomMoreButton">Zoom +++</button>
            <button id="zoomLessButton">Zoom ---</button>
            <button id="zoomCenterButton">Center</button>

        </div>
        <ul id="shapesList">
        </ul>
    </aside>

    <footer>
    </footer>
</body>

</html>