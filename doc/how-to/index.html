<!doctype html>
<html>

<head>
    <meta charset="utf-8">

    <title>Plane</title>

    <style>
        /* html structure */
        html,
        body {
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
        /* html structure */
        /* application structure */
        header {
            top: 0px;
            height: 40px;
            background-color: rgb(211, 222, 232);
        }
        aside {
            background-color: rgb(166, 217, 166);
        }
        aside[id=left] {
            position: absolute;
            left: 0px;
            top: 40px;
            bottom: 0px;
            width: 75px;
        }
        aside[id=right] {
            position: absolute;
            right: 0px;
            top: 40px;
            bottom: 0px;
            width: 200px;
        }
        section {
            position: absolute;
            top: 40px;
            left: 75px;
            right: 200px;
            bottom: 40px;
            background-color: rgb(234, 231, 231);
        }
        footer {
            position: absolute;
            left: 75px;
            right: 200px;
            bottom: 0px;
            height: 40px;
            background-color: rgb(239, 239, 212);
        }
        /* application structure */
        /* application components */
        canvas[id="rullery"] {
            position: absolute;
            height: 100%;
            width: 15px;
            background-color: rgb(204, 139, 139);
        }
        canvas[id="rullerx"] {
            position: absolute;
            bottom: 0px;
            height: 15px;
            width: 100%;
            background-color: rgb(204, 139, 139);
        }
        div[id="viewPort"] {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            background-color: rgb(255, 255, 255);
        }
        /* application components */
    </style>

    <script src="../../dist/plane-3.0.0.js"></script>

    <script>
        window.onload = function () {
            var viewPort = document.getElementById("viewPort");

            // plane - initialize
            plane.initialize({
                viewPort: viewPort
            });
            // plane - initialize

            plane.layer.create();


            plane.shape.create({
                type: 'arc',
                center: [700, 250],
                radius: 50,
                startAngle: 90,
                endAngle: 270
            });
            plane.shape.create({
                type: 'arc',
                center: [1200, 300],
                radius: 30,
                startAngle: 360,
                endAngle: 90
            });

            plane.shape.create({
                type: 'bezier-cubic',
                points: [[60, 190], [80, 10], [500, 10], [520, 190]]
            });

            plane.shape.create({
                type: 'bezier-quadratic',
                points: [[700, 100], [860, 0], [1000, 100]]
            });

            plane.shape.create({
                type: 'circle',
                center: [1200, 100],
                radius: 50
            });

            plane.shape.create({
                type: 'ellipse',
                center: [400, 300],
                radiusY: 50,
                radiusX: 100
            });

            plane.shape.create({
                type: 'line',
                from: [150, 450],
                to: [600, 500]
            });

            plane.shape.create({
                type: 'polygon',
                center: [900, 400],
                radius: 70,
                sides: 5
            });

            plane.shape.create({
                type: 'polyline',
                points: [[700, 100], [860, 0], [1000, 100]]
            });
            plane.shape.create({
                type: 'polyline',
                points: [[60, 190], [80, 10], [500, 10], [520, 190]]
            });

            plane.shape.create({
                type: 'rectangle',
                from: [0, 0],
                to: [viewPort.clientWidth, viewPort.clientHeight]
            });
            plane.shape.create({
                type: 'rectangle',
                from: [1350, 100],
                to: [1550, 300]
            });

            plane.shape.create({
                type: 'spline',
                degree: 3,
                knots: [0, 0, 0, 0, 1, 2, 3, 4, 4, 4, 4],
                points: [
                    [1099.987144430972, 649.9876187248264],
                    [1110.097044818745, 670.0304621818222],
                    [1120.20695803644, 649.9876187248264],
                    [1129.990734674595, 692.028699594638],
                    [1140.426771641907, 650.1505693076124],
                    [1149.884424530442, 669.7045610162513],
                    [1159.668201168597, 650.3135198903983]
                ]
            });
            plane.shape.create({
                type: 'polyline',
                points: [
                    [1099.987144430972, 649.9876187248264],
                    [1110.097044818745, 670.0304621818222],
                    [1120.20695803644, 649.9876187248264],
                    [1129.990734674595, 692.028699594638],
                    [1140.426771641907, 650.1505693076124],
                    [1149.884424530442, 669.7045610162513],
                    [1159.668201168597, 650.3135198903983]
                ]
            });



            plane.view.update();


            var toolZoomWheel = plane.tool.create({
                active: true
            });
            toolZoomWheel.events.listen('onMouseWheel', function (event) {

                var position = event.point,
                    zoomNew = event.delta < 0 ? plane.view.zoom / .83 : plane.view.zoom * .83,
                    zoomFactor = plane.view.zoom / zoomNew;

                var centerFactor = position.subtract(plane.view.center);
                var centerSum = position.subtract(centerFactor.multiply(zoomFactor)).subtract(plane.view.center);
                var centerNew = plane.view.center.sum(centerSum);

                plane.view.zoomTo(zoomNew, centerNew);

            });


            var toolPan = plane.tool.create({
                active: false
            });
            toolPan.events.listen('onMouseDrag', function (event) {

                var moveFactor = event.pointFirst.subtract(event.pointLast);
                var newCenter = plane.view.center.sum(moveFactor);

                plane.view.center = newCenter;

                console.log(plane.view.bounds);

            });


            var toolSelect = plane.tool.create({
                active: true
            });
            toolSelect.events.listen('onMouseDown', function (event) {

                plane.layer.active.children.list().forEach(function (shape) {
                    if (shape.status == 'temporary') {
                        plane.layer.active.children.remove(shape.uuid);
                    }
                });

                plane.view.update();


                // caso positivo realizamos a procura 
                //            if (imageData && layer.active && layer.active.status != 'system') {
                //                // apenas procuro na layer selecionada
                //                var children = layer.active.children.list(),
                //                    c = children.length;
                //
                //                while (c--) {
                //                    if (children[c].contains(pointInCanvas, view.transform)) {
                //                        shapesSelect.push(children[c]);
                //                        //                        break; - lilo - teste de performance
                //                    }
                //                }
                //            }

                //
                //                if (event.shapes.length > 0) {
                //
                //                    event.shapes.forEach(function (shape) {
                //                        shape.status = 'selected';
                //                        shape.style = {
                //                            lineColor: 'rgb(68, 121, 154)'
                //                        };
                //                    });
                //                }
                //
                //                plane.view.update();

            });
            toolSelect.events.listen('onMouseDrag', function (event) {

                plane.layer.active.children.list().forEach(function (shape) {
                    if (shape.status == 'temporary') {
                        plane.layer.active.children.remove(shape.uuid);
                    }
                });

                plane.shape.create({
                    type: 'rectangle',
                    from: [event.pointFirst.x, event.pointFirst.y],
                    to: [event.pointLast.x, event.pointLast.y],
                    status: 'temporary'
                });


                plane.layer.active.children.list().forEach(function (shape) {
                    if (shape.intersect({
                        x: event.pointFirst.x,
                        y: event.pointFirst.y,
                        height: event.pointLast.subtract(event.pointFirst).y,
                        width: event.pointLast.subtract(event.pointFirst).x,
                    })) {

                        console.log(shape.name);

                    }
                });

                plane.view.update();


            });


            plane.view.events.listen('onResize', function (events) {
                console.log(events);
            });







            var toolSpline = plane.tool.create({
                    active: false
                }),
                toolSplinePoints = [];

            function clamp(x, a, b) {
                return (x < a) ? a : ((x > b) ? b : x);
            }

            toolSpline.events.listen('onActive', function (event) {

                toolSplinePoints = [];
                xxx = [];

                document.getElementById('toolSpline').classList.add('selected');
            });

            toolSpline.events.listen('onMouseMove', function (event) {

                if (toolSplinePoints.length > 1) {

                    toolSplinePoints = toolSplinePoints.filter(function (item) {
                        return item.type == 'click';
                    });
                    //                    toolSplinePoints.push({
                    //                        x: event.point.inView.x,
                    //                        y: event.point.inView.y,
                    //                        type: 'move'
                    //                    });


                    plane.layer.active.children.list().forEach(function (shape) {
                        if (shape.status == 'temporary') {
                            plane.layer.active.children.remove(shape.uuid);
                        }
                    });

                    var nurbsControlPoints = toolSplinePoints,
                        nurbsKnots = [],
                        nurbsDegree = 3;

                    for (var i = 0; i <= nurbsDegree; i++) {
                        nurbsKnots.push(0);
                    }
                    for (var i = 0, j = nurbsControlPoints.length; i < j; i++) {
                        var knot = (i + 1) / (j - nurbsDegree);
                        nurbsKnots.push(clamp(knot, 0, 1));
                    }


                    plane.shape.create({
                        type: 'spline',
                        degree: nurbsDegree,
                        knots: nurbsKnots,
                        points: nurbsControlPoints,
                        status: 'temporary'
                    });

                    plane.view.update();
                }

            });
            toolSpline.events.listen('onMouseDown', function (event) {
                toolSplinePoints.push({
                    x: event.point.x,
                    y: event.point.y,
                    type: 'click'
                });
                //                toolSplinePoints.push(event.point);
            });







            document.getElementById('fileImport').addEventListener('change', function () {
                var file = this.files[0],
                    filename = file.name;

                var lastDotPosition = filename.lastIndexOf('.'),
                    bareFilename = filename.substr(0, lastDotPosition),
                    fileExtension = filename.substr(lastDotPosition + 1).toLowerCase();

                var reader = new FileReader();
                reader.onload = function (event) {

                    var fileData = event.target.result;

                    switch (fileExtension) {
                    case 'dxf':
                        plane.importer.fromDxf(fileData);
                        break;
                    case 'json':
                        plane.importer.fromJson(fileData);
                        break;
                    default:
                        return;
                    }

                };
                reader.readAsText(file);
            });

            document.getElementById('exportJsonButton').addEventListener('click', function (event) {
                console.log(plane.exporter.toJson());
            });

            document.getElementById('zoomMoreButton').addEventListener('click', function (event) {
                plane.view.zoom /= .93;
            });

            document.getElementById('zoomLessButton').addEventListener('click', function (event) {
                plane.view.zoom *= .93;
            });

            document.getElementById('zoomHomeButton').addEventListener('click', function (event) {
                plane.view.reset();
            });

        };
    </script>

</head>

<body>

    <header>
    </header>

    <aside id="left">
    </aside>

    <section>
        <div id="viewPort">
        </div>
    </section>

    <aside id="right">
        <ul id="layersControl">
        </ul>
        <div id="toolsPanel">
            <input id="fileImport" type="file"></input>
            <button id="exportJsonButton">Export Json</button>
            <br>
            <br>
            <label>x</label>
            <input id="zoomCenterInputX" type="text" style="width:60px" value="0">
            <label>y</label>
            <input id="zoomCenterInputY" type="text" style="width:60px" value="0">
            <button id="zoomMoreButton">Zoom +++</button>
            <button id="zoomLessButton">Zoom ---</button>
            <button id="zoomHomeButton">Home</button>

        </div>
        <ul id="shapesList">
        </ul>
    </aside>

    <footer>
    </footer>
</body>

</html>